# 다국어(i18n) 시스템

> next-intl 기반 5개 언어 지원 (ko, en, ja, zh-CN, zh-TW)

## 개요

| 항목 | 값 |
|------|-----|
| 라이브러리 | next-intl |
| 지원 언어 | ko (기본), en, ja, zh-CN, zh-TW |
| 라우팅 방식 | URL prefix (`/en/home`, `/ja/home`) |
| 기본 언어 prefix | 생략 가능 (`/home` = `/ko/home`) |
| 메시지 파일 | `/locales/{locale}.json` (~1,500줄) |
| Python 다국어 | `python/prompts/locale_strings.py` |

## 파일 구조

```
src/
├── i18n/
│   ├── routing.ts          # 언어 목록, 라우팅 설정
│   └── request.ts          # 서버 요청 시 메시지 로드
├── middleware.ts           # i18n + Supabase 세션 통합
└── app/
    └── [locale]/           # 모든 다국어 페이지

locales/
├── ko.json                 # 한국어 (기본)
├── en.json                 # 영어
├── ja.json                 # 일본어
├── zh-CN.json              # 중국어 간체
└── zh-TW.json              # 중국어 번체

python/prompts/
└── locale_strings.py       # AI 프롬프트 다국어 문자열
```

## 핵심 설정 파일

### routing.ts

```typescript
// src/i18n/routing.ts
export const locales = ['ko', 'en', 'ja', 'zh-CN', 'zh-TW'] as const;

export const routing = defineRouting({
  locales,
  defaultLocale: 'ko',
  localePrefix: 'as-needed',  // 기본 언어는 prefix 생략
});

// 커스텀 네비게이션 헬퍼 (next/link 대신 사용)
export const { Link, redirect, usePathname, useRouter } = createNavigation(routing);
```

### request.ts

```typescript
// src/i18n/request.ts - 서버에서 메시지 로드
export default getRequestConfig(async ({ requestLocale }) => {
  let locale = await requestLocale;
  if (!locale || !hasLocale(locales, locale)) {
    locale = 'ko';
  }
  return {
    locale,
    messages: (await import(`../../locales/${locale}.json`)).default,
  };
});
```

### middleware.ts

미들웨어 처리 순서:
1. Admin 경로 → i18n 미적용, 직접 처리
2. Supabase 세션 갱신
3. 공개/보호 페이지 확인
4. i18n 미들웨어 실행
5. **중요**: Supabase 쿠키를 intlResponse에 복사

```typescript
// 핵심 패턴: 쿠키 복사
const intlResponse = intlMiddleware(request);
response.cookies.getAll().forEach((cookie) => {
  intlResponse.cookies.set(cookie.name, cookie.value, cookie);
});
```

## 사용 패턴

### 클라이언트 컴포넌트

```typescript
'use client';
import { useTranslations } from 'next-intl';

function MyComponent() {
  const t = useTranslations('namespace');      // 네임스페이스 지정
  const tCommon = useTranslations('common');   // 여러 네임스페이스 사용 가능

  return (
    <div>
      <h1>{t('title')}</h1>
      <p>{t('nested.key')}</p>                 {/* 점 표기법 */}
      <p>{t(`dynamic.${variable}`)}</p>        {/* 동적 키 */}
    </div>
  );
}
```

### 배열 메시지 사용 (t.raw)

```typescript
'use client';
import { useTranslations } from 'next-intl';

function TipsComponent() {
  const t = useTranslations('pipeline');

  // t.raw()로 배열 가져오기
  const tips = t.raw('tips') as string[];

  return (
    <ul>
      {tips.map((tip, index) => (
        <li key={index}>{tip}</li>
      ))}
    </ul>
  );
}
```

**메시지 파일 구조 (배열)**:
```json
{
  "pipeline": {
    "tips": [
      "첫 번째 팁",
      "두 번째 팁",
      "세 번째 팁"
    ]
  }
}
```

### 서버 컴포넌트 (Metadata)

```typescript
import { getTranslations } from 'next-intl/server';

export async function generateMetadata({ params }: Props): Promise<Metadata> {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: 'metadata' });

  return {
    title: t('pages.home.title'),
    description: t('pages.home.description'),
  };
}
```

### 네비게이션 (Link/Router)

```typescript
// next/link 대신 사용
import { Link, useRouter } from '@/i18n/routing';

// Link
<Link href="/profiles">프로필</Link>

// Router
const router = useRouter();
router.push('/home');
router.replace('/auth/signin');
```

## 메시지 파일 구조

```json
{
  "metadata": {
    "title": "Master's Insight",
    "pages": {
      "home": { "title": "...", "description": "..." },
      "landing": { "title": "...", "description": "..." }
    }
  },
  "common": {
    "appName": "Master's Insight",
    "loading": "로딩 중...",
    "error": "오류가 발생했습니다",
    "credits": "크레딧"
  },
  "nav": { "login": "로그인", "signup": "회원가입" },
  "auth": {
    "signin": { "title": "...", "errors": { "emailNotConfirmed": "..." } },
    "signup": { ... }
  },
  "analysis": { ... },
  "yearly": { ... },
  "compatibility": { ... },
  "profile": { ... },
  "consultation": { ... },
  "payment": { ... }
}
```

**네임스페이스 예시**:
- `common` - 공통 UI 텍스트
- `auth.signin` - 로그인 페이지
- `analysis.full` - 사주 분석
- `yearly.processing` - 신년 분석 진행 중
- `metadata.pages.home` - 홈페이지 SEO

## Python 다국어 처리

### locale_strings.py

```python
# 다국어 문자열 DB
LOCALE_STRINGS = {
    'focus_area_header': {
        'ko': '## 집중 분석 영역: {label}',
        'en': '## Focus Area: {label}',
        'ja': '## 重点分析領域：{label}',
        'zh-CN': '## 重点分析领域：{label}',
        'zh-TW': '## 重點分析領域：{label}',
    },
    # ... 200+ 문자열
}

STEP_LABELS = {
    'basic': { 'ko': '기본 분석', 'en': 'Basic Analysis', ... },
    'personality': { ... },
    # ...
}
```

### 핵심 함수

```python
from prompts.locale_strings import get_locale_string, format_pillars_table

# 기본 사용
text = get_locale_string('focus_area_header', 'ko', label='재물운')
# → "## 집중 분석 영역: 재물운"

# 포맷팅 함수
pillar_table = format_pillars_table(hour, day, month, year, 'ko')
daewun_list = format_daewun_list(daewun_items, 'en')
ten_gods_ctx = format_ten_gods_context(ten_gods_data, 'ja')
```

### 한국어 조사 처리

```python
from prompts.locale_strings import apply_korean_particles

apply_korean_particles('운명', 'topic')   # "운명은" (받침 있음)
apply_korean_particles('사주', 'topic')   # "사주는" (받침 없음)

# 지원 조사
# 'topic': 은/는
# 'subject': 이/가
# 'object': 을/를
# 'with': 과/와
```

## 새 페이지 추가 체크리스트

1. **라우트 생성**: `src/app/[locale]/새페이지/page.tsx`
2. **메시지 추가**: 5개 JSON 파일에 동일 구조 추가
3. **Metadata 추가**: `metadata.pages.새페이지` 네임스페이스
4. **Python (필요시)**: `locale_strings.py`에 문자열 추가

## 새 언어 추가 체크리스트

1. **routing.ts**: `locales` 배열에 추가
2. **locales/**: `{새언어}.json` 파일 생성 (ko.json 복사 후 번역)
3. **locale_strings.py**: 각 딕셔너리에 새 언어 키 추가

## 주의사항

### 미들웨어 쿠키 복사

i18n 미들웨어는 새 Response를 반환하므로, Supabase 쿠키를 명시적으로 복사해야 함:

```typescript
// middleware.ts - 필수 패턴
const intlResponse = intlMiddleware(request);
response.cookies.getAll().forEach((cookie) => {
  intlResponse.cookies.set(cookie.name, cookie.value, cookie);
});
return intlResponse;
```

### Admin 페이지

- `/admin` 경로는 i18n 미지원
- 미들웨어에서 별도 처리 (바이패스)

### Link 컴포넌트

```typescript
// ❌ 잘못된 사용
import Link from 'next/link';

// ✅ 올바른 사용
import { Link } from '@/i18n/routing';
```

### 동적 키 접근

```typescript
// ✅ 동적 키
const errorKey = 'emailNotConfirmed';
t(`errors.${errorKey}`);

// ❌ 객체 접근 불가
t.errors[errorKey];  // TypeError
```

## 폴백 전략

1. **프론트엔드**: 키 미존재 시 키 이름 그대로 표시
2. **Python**: 미지원 언어 → 영어 → 기본값 반환
3. **레거시 처리**: `zh` → `zh-CN` 자동 변환

## 관련 문서

- [next-intl 공식 문서](https://next-intl.dev/)
- `docs/api.md` - API 요청 시 locale 파라미터
- `docs/fortune_engine.md` - Python 엔진 다국어 프롬프트

---

**Version**: 1.0.0
**Last Updated**: 2026-01-14
