# 다국어(i18n) 시스템

> next-intl 기반 5개 언어 지원 (ko, en, ja, zh-CN, zh-TW)

---

## 핵심 원칙

> **리포트 결과는 분석 시점 언어로 DB 저장 (나중에 번역 X)**

- UI 라벨(섹션 제목, 탭명)만 동적 다국어화
- AI 분석 결과는 저장된 언어 그대로 표시
- `ko.json`을 기준(source of truth)으로 다른 4개 언어 동기화

---

## 파일 구조

| 구분 | 파일 |
|------|------|
| 라우팅 설정 | `src/i18n/routing.ts` |
| 서버 요청 | `src/i18n/request.ts` |
| 미들웨어 | `src/middleware.ts` |
| 메시지 파일 | `locales/{ko,en,ja,zh-CN,zh-TW}.json` |
| Python 다국어 | `python/prompts/locale_strings.py` |

---

## 코드 패턴

### 클라이언트 컴포넌트

```typescript
import { useTranslations, useLocale } from 'next-intl';

const t = useTranslations('namespace');
const locale = useLocale();

// 여러 네임스페이스 필요 시
const tCommon = useTranslations('common');
const tCredits = useTranslations('credits');
```

### 서버 컴포넌트

```typescript
import { getTranslations } from 'next-intl/server';

const t = await getTranslations({ locale, namespace: 'metadata' });
```

### 네비게이션

```typescript
// next/link 대신 사용
import { Link, useRouter } from '@/i18n/routing';
```

### 배열 메시지

```typescript
const tips = t.raw('tips') as string[];
```

### API에 언어 전달

```typescript
const locale = useLocale();
await fetch('/api/endpoint', {
  method: 'POST',
  body: JSON.stringify({ language: locale, ...data })
});
```

---

## 번역 키 규칙

### 네임스페이스 구조

| 네임스페이스 | 용도 | 예시 |
|-------------|------|------|
| `common` | 공통 UI | 버튼, 로딩, 에러 |
| `credits` | 크레딧 관련 | 차감, 부족, 충전 |
| `payment` | 결제 관련 | 결제수단, 가격, 성공 |
| `report` | 리포트 UI | 섹션명, 탭명, 라벨 |
| `analysis` | 분석 관련 | 파이프라인, 탭, 결과 |
| `profile` | 프로필 관련 | 입력폼, 목록, 상세 |
| `consultation` | 상담 관련 | 세션, 메시지, 상태 |
| `dailyFortune` | 오늘의 운세 | 점수, 조언, 구독 |
| `compatibility` | 궁합 분석 | 점수, 해석, 비교 |
| `yearly` | 신년 분석 | 월별, 분기별, 조언 |

### 키 네이밍

```json
{
  "섹션명": {
    "title": "제목",
    "subtitle": "부제목",
    "description": "설명",
    "empty": "데이터 없음 메시지",
    "error": "에러 메시지",
    "actions": {
      "confirm": "확인",
      "cancel": "취소"
    }
  }
}
```

### 변수 삽입

```json
{
  "message": "{name}님의 분석 결과입니다",
  "credits": "{amount}C가 차감됩니다",
  "date": "{year}년 {month}월"
}
```

---

## 신규 키 추가 작업

### 1. ko.json에 먼저 추가

```json
// locales/ko.json
{
  "newFeature": {
    "title": "새 기능",
    "description": "설명 텍스트"
  }
}
```

### 2. 다른 4개 언어 동기화

```bash
# 누락 키 검출
jq 'paths(scalars) | join(".")' locales/ko.json | sort > /tmp/ko.txt
jq 'paths(scalars) | join(".")' locales/en.json | sort > /tmp/en.txt
diff /tmp/ko.txt /tmp/en.txt

# jq로 키 추가 (예시)
jq '.newFeature = {"title": "New Feature", "description": "Description"}' \
  locales/en.json > tmp.json && mv tmp.json locales/en.json
```

### 3. 빌드 테스트

```bash
npm run build
```

---

## Python 다국어 (AI 프롬프트)

### locale_strings.py 사용

```python
from prompts.locale_strings import get_locale_string

header = get_locale_string('pillars_header', language)
# ko: "## 사주 팔자 (四柱八字)"
# en: "## Four Pillars Chart (BaZi)"
```

### 언어 폴백

- 지원 언어: `ko`, `en`, `ja`, `zh-CN`, `zh-TW`
- 미지원 언어 → `en`으로 폴백
- `zh` → `zh-CN`으로 자동 변환

---

## 언어별 특성

| 언어 | 코드 | 특이사항 |
|------|------|----------|
| 한국어 | `ko` | 기준 언어, 조사(은/는) 처리 필요 |
| 영어 | `en` | 폴백 언어 |
| 일본어 | `ja` | 한자 + 히라가나 혼용 |
| 간체중문 | `zh-CN` | 중국 본토용 |
| 번체중문 | `zh-TW` | 대만/홍콩용 |

### 한국어 조사 처리

```python
from prompts.locale_strings import apply_korean_particles

apply_korean_particles("사주", "topic")  # "사주는"
apply_korean_particles("운세", "topic")  # "운세는"
```

---

## 주의사항

1. **하드코딩 금지**: UI 텍스트는 반드시 `t('key')` 사용
2. **ko 기준 동기화**: 새 키 추가 시 5개 파일 모두 업데이트
3. **AI 결과 번역 X**: 리포트/분석 결과는 생성 시점 언어로 고정
4. **compatibility_prompts.py**: AI 참조용이므로 다국어화 불필요
5. **동적 키 참조 주의**: `t(variable)` 형태로 변수를 키로 사용할 때 해당 키가 번역 파일에 존재하는지 반드시 확인

### 동적 키 참조 예시

```typescript
// ReportNavigation.tsx - 탭 ID를 키로 사용
const TAB_IDS = ['saju', 'daewun', 'consultation'];
{TAB_IDS.map(tabId => <button>{t(tabId)}</button>)}

// 이 경우 report.navigation에 saju, daewun, consultation 키가 필요
```

**동적 키 참조 패턴 검색**:
```bash
grep -r "t([a-zA-Z_][a-zA-Z0-9_]*)" src --include="*.tsx"
```

---

**Version**: 3.1.0
**Last Updated**: 2026-01-14

## Changelog

### v3.1.0 (2026-01-14)
- 동적 키 참조 주의사항 및 검색 방법 추가
- 누락 키 수정:
  - `report.navigation.daewun`, `report.navigation.consultation` 추가
  - `profile.validation.invalidCalendarType` 추가
